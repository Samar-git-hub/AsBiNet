# Source: https://github.com/open-mmlab/mmsegmentation/blob/main/mmseg/datasets/basesegdataset.py

from mmseg.registry import DATASETS
from mmseg.datasets import BaseSegDataset
import pandas as pd
import os.path as osp

@DATASETS.register_module()
class FracAtlasDataset(BaseSegDataset):

    # Class directly reads the CSV files generated by augment.py
    METAINFO = dict(
        classes=('background', 'fracture'),
        palette=[[0, 0, 0], [255, 0, 0]],
        label_map = {0: 0, 255: 1}
    )

    def __init__(self, **kwargs):
        
        super().__init__(img_suffix='.jpg', 
                         seg_map_suffix='.png',
                         reduce_zero_label=False,
                         **kwargs)

    
    def load_data_list(self):

        csv_path = self.ann_file

        if not osp.exists(csv_path):
            csv_path = osp.join(self.data_root, self.ann_file)

        df = pd.read_csv(csv_path)

        data_list = []
        

        for _, row in df.iterrows():
            data_info = dict()

            data_info['img_path'] = row['image_id']
            data_info['seg_map_path'] = row['mask_file']

            data_info['label_map'] = self.label_map
            data_info['reduce_zero_label'] = self.reduce_zero_label
            data_info['seg_fields'] = []

            data_list.append(data_info)

        return data_list
